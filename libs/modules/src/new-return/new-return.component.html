<ion-content padding>
  <mat-card class="card-main" *ngIf="return">
    <mat-card-header>
      <mat-card-title># {{return.id}}</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <ion-grid>
        <ion-row>
          <ion-col size="8">
            <ion-item>
              <ion-label position="stacked">Unidades</ion-label>
              <suite-view-button slot="start" position="bottom" class="ion-margin-vertical filter" [listItems]="this.productsByBrand"></suite-view-button>
              <ion-input disabled>
                <span class="unities-total">{{return.products.length}} uds. asignadas</span> -<span class="unities-scanned">{{getCountProductsScanned(return.products)}} uds. escaneadas</span>
              </ion-input>
              <ion-button slot="end" class="btn-see-unities" *ngIf="availableUnities" (click)="showAvailableUnities()">{{return.id ? 'Ver unidades' : 'Ver unidades disponibles'}}</ion-button>
              <ion-button slot="end" class="btn-select-unities" [disabled]="!return.id || isHistoric || return.status != ReturnStatus.RETURN_ORDER" (click)="selectUnitiesItems()">Seleccionar unidades</ion-button>
            </ion-item>
          </ion-col>

          <ion-col size="4" class="disabled-col">
            <ion-item>
              <ion-label position="stacked">Último estado</ion-label>
              <ion-input disabled>{{getStatusName(return.lastStatus)}}</ion-input>
            </ion-item>
          </ion-col>
        </ion-row>

        <ion-row>
          <ion-col size="4">
            <ion-item [disabled]="isHistoric" (click)="openShowSelectableList(1)" class="item-selectable">
              <ion-label>Tipo{{ requiredFields.type ? ' *' : '' }}</ion-label>
              <ion-label>{{return.type ? return.type.name : ''}}</ion-label>
              <ion-icon name="ios-arrow-forward" slot="end"></ion-icon>
            </ion-item>
          </ion-col>

          <ion-col size="4">
            <ion-item [disabled]="isHistoric" (click)="openShowSelectableList(2)" class="item-selectable">
              <ion-label>Almacén{{ requiredFields.warehouse ? ' *' : '' }}</ion-label>
              <ion-label>{{return.warehouse ? return.warehouse.name : ''}}</ion-label>
              <ion-icon name="ios-arrow-forward" slot="end"></ion-icon>
            </ion-item>
          </ion-col>

          <ion-col size="4">
            <ion-item [disabled]="isHistoric">
              <ion-label position="stacked">Cambiar estado</ion-label>
              <ion-select [selectedText]="''" placeholder="Seleccione un nuevo estado"
                          (ionChange)="changeStatus($event.detail.value)">
                <ion-select-option *ngFor="let status of listStatusAvailable"
                                   [value]="status.id">{{status.name}}</ion-select-option>
              </ion-select>
            </ion-item>
          </ion-col>
        </ion-row>

        <ion-row>
          <ion-col size="4">
            <div class="provider">
              <ion-item [disabled]="isHistoric" (click)="openShowSelectableList(3)" class="item-provider" [ngClass]="thereAreConditions() ? 'reduce-width' : ''">
                <ion-label class="title">Proveedor{{ requiredFields.provider ? ' *' : '' }}</ion-label>
                <ion-label class="value">{{return.provider ? return.provider.name : ''}}</ion-label>
                <ion-icon name="ios-arrow-forward" slot="end"></ion-icon>
              </ion-item>
              <div class="conditions" *ngIf="thereAreConditions()">
                <ion-button [disabled]="isHistoric" (click)="selectCondition()">Condiciones</ion-button>
              </div>
            </div>
          </ion-col>

          <ion-col size="4">
            <ion-item [disabled]="isHistoric">
              <ion-label position="stacked">Marcas{{ requiredFields.brand ? ' *' : '' }}</ion-label>
              <ion-input *ngIf="!return.provider" disabled placeholder="Debe seleccionar un proveedor"></ion-input>
              <ion-select *ngIf="return.provider" [interfaceOptions]="{cssClass: 'wide-alert'}"
                          [selectedText]="return.brands ? getBrandNameList(return.brands) : ''"
                          placeholder="Seleccione las marcas" multiple
                          (ionChange)="return.brands = $event.detail.value">
                <ion-select-option *ngFor="let brand of return.provider.brands"
                                   [value]="brand">{{brand.name}}</ion-select-option>
              </ion-select>
            </ion-item>
          </ion-col>

          <ion-col size="4" class="disabled-col">
            <ion-item class="item-date">
              <ion-label position="stacked">Fecha último estado</ion-label>
              <ion-input
                disabled>{{return.dateLastStatus ? formatDate(return.dateLastStatus) : 'Esta fecha se rellenará automáticamente'}}</ion-input>
            </ion-item>
          </ion-col>
        </ion-row>

        <ion-row>
          <ion-col size="4">
            <ion-item>
              <ion-label position="stacked">Correo de contacto</ion-label>
              <ion-input [disabled]="isHistoric" [(ngModel)]="return.email"></ion-input>
            </ion-item>
          </ion-col>

          <ion-col size="4">
            <ion-item class="item-date" [disabled]="isHistoric">
              <ion-label position="stacked">Devolver antes
                de{{ requiredFields.returnBeforeDate ? ' *' : '' }}</ion-label>
              <input matInput [matDatepicker]="pickerDateReturnBefore" [(ngModel)]="return.dateReturnBefore"
                     placeholder="Seleccione una fecha">
              <mat-datepicker-toggle matSuffix [for]="pickerDateReturnBefore"></mat-datepicker-toggle>
              <mat-datepicker #pickerDateReturnBefore></mat-datepicker>
            </ion-item>
          </ion-col>

          <ion-col size="4" class="disabled-col">
            <ion-item>
              <ion-label position="stacked">Usuario</ion-label>
              <ion-input disabled>{{return.user.name}}</ion-input>
            </ion-item>
          </ion-col>
        </ion-row>

        <ion-row>
          <ion-col>
            <ion-item [disabled]="isHistoric">
              <ion-label position="stacked">Observaciones</ion-label>
              <ion-textarea rows="6" cols="20" placeholder="Introduzca aquí sus observaciones"
                            [(ngModel)]="return.observations" type="text"></ion-textarea>
            </ion-item>
          </ion-col>
        </ion-row>
      </ion-grid>
    </mat-card-content>
  </mat-card>

  <mat-card *ngIf="return">
    <mat-card-header>
      <mat-card-title>
        A rellenar por el operario
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <ion-grid>
        <ion-row>
          <ion-col size="4" class="disabled-col">
            <ion-item>
              <ion-label position="stacked">Jaulas contenedoras</ion-label>
              <ion-input disabled>{{getPackingNames(return.packings)}}</ion-input>
            </ion-item>
          </ion-col>

          <ion-col size="4">
            <ion-item>
              <ion-label position="stacked">Nº Bultos{{ requiredFields.quantityPacking ? ' *' : '' }}</ion-label>
              <ion-input [disabled]="isHistoric" [(ngModel)]="return.amountPackages" type="number"></ion-input>
            </ion-item>
          </ion-col>

          <ion-col size="4">
            <ion-item class="item-date" [disabled]="isHistoric">
              <ion-label position="stacked">Fecha prevista de
                recogida{{ requiredFields.pickupDate ? ' *' : '' }}</ion-label>
              <input matInput [matDatepicker]="pickerDatePredictedPickup" [(ngModel)]="return.datePredictedPickup">
              <mat-datepicker-toggle matSuffix [for]="pickerDatePredictedPickup"></mat-datepicker-toggle>
              <mat-datepicker #pickerDatePredictedPickup></mat-datepicker>
            </ion-item>
          </ion-col>
        </ion-row>

        <ion-row>
          <ion-col size="4">
            <ion-item>
              <ion-label position="stacked">Agencia transportista{{ requiredFields.shipper ? ' *' : '' }}</ion-label>
              <ion-input [disabled]="isHistoric" [(ngModel)]="return.shipper"></ion-input>
            </ion-item>
          </ion-col>

          <ion-col size="4">
            <ion-item>
              <div class="div-btn-item">
                <ion-button matTooltip="Adjuntar albarán de agencia" matTooltipClass="tooltip" slot="start" fill="clear" [disabled]="!return || (!return.id && !requiredFields.deliveryNote) || isHistoric" (click)="searchDelivery_note()">
                  <ion-icon name="image" slot="start"></ion-icon>albarán agencia{{requiredFields.deliveryNote ? ' *' : ''}}
                </ion-button>
              </div>
            </ion-item>
          </ion-col>

          <ion-col size="4" class="disabled-col">
            <ion-item class="item-date">
              <ion-label position="stacked">Fecha de recogida</ion-label>
              <ion-input
                disabled>{{return.datePickup ? formatDate(return.datePickup) : 'Esta fecha se rellenará más adelante'}}</ion-input>
            </ion-item>
          </ion-col>
        </ion-row>

        <ion-row>
          <ion-col>
            <ion-item [disabled]="isHistoric">
              <ion-label position="stacked">Observaciones del operario</ion-label>
              <ion-textarea rows="3" cols="20" placeholder="Introduzca aquí sus observaciones"
                            [(ngModel)]="return.operatorObservations" type="text"></ion-textarea>
            </ion-item>
          </ion-col>
        </ion-row>
      </ion-grid>
    </mat-card-content>
  </mat-card>
</ion-content>

<ion-footer>
  <ion-toolbar>
    <ion-button matTooltip="Imprimir/enviar albarán" matTooltipClass="tooltip" slot="start" fill="clear" [disabled]="true || isHistoric"><ion-icon name="print" slot="start"></ion-icon>albarán</ion-button>
    <ion-button matTooltip="Adjuntar archivos/imágenes" matTooltipClass="tooltip" slot="start" fill="clear" [disabled]="!return || !return.id || isHistoric" (click)="searchArchive()"><ion-icon name="attach" slot="start"></ion-icon>archivos/imágenes</ion-button>

    <ion-button *ngIf="!isHistoric" slot="end" color="light" (click)="router.navigateByUrl('/return-tracking-list')">Cancelar</ion-button>
    <ion-button *ngIf="isHistoric" slot="end" color="light" (click)="router.navigateByUrl('/returns-historic')">Cancelar</ion-button>
    <ion-button slot="end" color="primary" [disabled]="!allFieldsFilled() || isHistoric" (click)="save(null)">Guardar</ion-button>
  </ion-toolbar>
</ion-footer>
