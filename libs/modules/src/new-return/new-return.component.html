<ion-content padding>
  <mat-card *ngIf="return" [ngClass]="{'from-history': isHistoric}">
    <mat-card-header>
      <mat-card-title># {{return.id}}</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <ion-grid>
        <ion-row>
          <ion-col size="8">
            <ion-item>
              <ion-label position="stacked">Unidades</ion-label>
              <ion-input disabled>
                <span class="unities-total">{{return.products.length}} uds. asignadas</span> -<span class="unities-scanned">{{getCountProductsScanned(return.products)}} uds. escaneadas</span>
              </ion-input>
              <ion-button slot="end" class="btn-see-unities" *ngIf="availableUnities" (click)="showAvailableUnities()">{{return.id && return.products ? 'Ver unidades' : 'Ver unidades disponibles'}}</ion-button>
              <ion-button slot="end" class="btn-select-unities" *ngIf="!isHistoric" [disabled]="!return.id || return.status != ReturnStatus.RETURN_ORDER" (click)="selectUnitiesItems()">Seleccionar unidades</ion-button>
            </ion-item>
          </ion-col>

          <ion-col size="4" [ngClass]="{'disabled-col': !isHistoric}">
            <ion-item>
              <ion-label position="stacked">Último estado</ion-label>
              <ion-input disabled>{{getStatusName(return.lastStatus)}}</ion-input>
            </ion-item>
          </ion-col>
        </ion-row>

        <ion-row>
          <ion-col size="4">
            <ion-item *ngIf="isHistoric else typeSelection">
              <ion-label position="stacked">Tipo de devolución</ion-label>
              <ion-input disabled>{{return.type ? return.type.name : ''}}</ion-input>
            </ion-item>
            <ng-template #typeSelection>
              <ion-item (click)="openShowSelectableList(1)" class="item-selectable">
                <ion-label>Tipo{{ requiredFields.type ? ' *' : '' }}</ion-label>
                <ion-label>{{return.type ? return.type.name : ''}}</ion-label>
                <ion-icon name="ios-arrow-forward" slot="end"></ion-icon>
              </ion-item>
            </ng-template>
          </ion-col>

          <ion-col size="4">
            <ion-item *ngIf="isHistoric else warehouseSelection">
              <ion-label position="stacked">Almacén</ion-label>
              <ion-input disabled>{{return.warehouse ? return.warehouse.name : ''}}</ion-input>
            </ion-item>
            <ng-template #warehouseSelection>
              <ion-item (click)="openShowSelectableList(2)" class="item-selectable">
                <ion-label>Almacén{{ requiredFields.warehouse ? ' *' : '' }}</ion-label>
                <ion-label>{{return.warehouse ? return.warehouse.name : ''}}</ion-label>
                <ion-icon name="ios-arrow-forward" slot="end"></ion-icon>
              </ion-item>
            </ng-template>
          </ion-col>

          <ion-col size="4" *ngIf="!isHistoric">
            <ion-item>
              <ion-label position="stacked">Cambiar estado</ion-label>
              <ion-select [selectedText]="''" placeholder="Seleccione un nuevo estado"
                          (ionChange)="changeStatus($event.detail.value)">
                <ion-select-option *ngFor="let status of listStatusAvailable"
                                   [value]="status.id">{{status.name}}</ion-select-option>
              </ion-select>
            </ion-item>
          </ion-col>
        </ion-row>

        <ion-row>
          <ion-col size="4">
            <ion-item *ngIf="isHistoric else providerSelection">
              <ion-label position="stacked">Proveedor</ion-label>
              <ion-input disabled>{{return.provider ? return.provider.name : ''}}</ion-input>
            </ion-item>
            <ng-template #providerSelection>
              <div class="provider">
                <ion-item (click)="openShowSelectableList(3)" class="item-provider" [ngClass]="thereAreConditions() ? 'reduce-width' : ''">
                  <ion-label class="title">Proveedor{{ requiredFields.provider ? ' *' : '' }}</ion-label>
                  <ion-label class="value">{{return.provider ? return.provider.name : ''}}</ion-label>
                  <ion-icon name="ios-arrow-forward" slot="end"></ion-icon>
                </ion-item>
                <div class="conditions" *ngIf="thereAreConditions()">
                  <ion-button (click)="selectCondition()">Condiciones</ion-button>
                </div>
              </div>
            </ng-template>
          </ion-col>

          <ion-col size="4">
            <ion-item [disabled]="isHistoric">
              <ion-label position="stacked">Marcas{{ !isHistoric && requiredFields.brand ? ' *' : '' }}</ion-label>
              <ion-input disabled *ngIf="isHistoric else brandsSelection" [matTooltip]="getBrandNameList(return.brands)">{{ getBrandNameList(return.brands) }}</ion-input>
              <ng-template #brandsSelection>
                <ion-input *ngIf="!return.provider" disabled placeholder="Debe seleccionar un proveedor"></ion-input>
                <ion-select *ngIf="return.provider" [interfaceOptions]="{cssClass: 'wide-alert'}"
                            [selectedText]="return.brands ? getBrandNameList(return.brands) : ''"
                            placeholder="Seleccione las marcas" multiple
                            (ionChange)="return.brands = $event.detail.value">
                  <ion-select-option *ngFor="let brand of return.provider.brands"
                                     [value]="brand">{{brand.name}}</ion-select-option>
                </ion-select>
              </ng-template>
            </ion-item>
          </ion-col>

          <ion-col size="4" [ngClass]="{'disabled-col': !isHistoric}">
            <ion-item class="item-date">
              <ion-label position="stacked">Fecha del último cambio de estado</ion-label>
              <ion-input
                disabled>{{return.dateLastStatus ? formatDate(return.dateLastStatus) : 'Esta fecha se rellenará automáticamente'}}</ion-input>
            </ion-item>
          </ion-col>
        </ion-row>

        <ion-row>
          <ion-col size="4">
            <ion-item>
              <ion-label position="stacked">Correo de contacto</ion-label>
              <ion-input [disabled]="isHistoric" [(ngModel)]="return.email"></ion-input>
            </ion-item>
          </ion-col>

          <ion-col size="4">
            <ion-item class="item-date" [disabled]="isHistoric">
              <ion-label position="stacked">Devolver antes
                de{{ !isHistoric && requiredFields.returnBeforeDate ? ' *' : '' }}</ion-label>
              <input matInput [matDatepicker]="pickerDateReturnBefore" [(ngModel)]="return.dateReturnBefore"
                     placeholder="Seleccione una fecha">
              <mat-datepicker-toggle matSuffix [for]="pickerDateReturnBefore"></mat-datepicker-toggle>
              <mat-datepicker #pickerDateReturnBefore></mat-datepicker>
            </ion-item>
          </ion-col>

          <ion-col size="4" [ngClass]="{'disabled-col': !isHistoric}">
            <ion-item>
              <ion-label position="stacked">Usuario</ion-label>
              <ion-input disabled>{{return.user.name}}</ion-input>
            </ion-item>
          </ion-col>
        </ion-row>

        <ion-row>
          <ion-col>
            <ion-item [disabled]="isHistoric">
              <ion-label position="stacked">Observaciones</ion-label>
              <ion-textarea rows="6" cols="20" [placeholder]="isHistoric ? 'No se ha añadido ninguna observación a la devolución' : 'Introduzca aquí sus observaciones'"
                            [(ngModel)]="return.observations" type="text"></ion-textarea>
            </ion-item>
          </ion-col>
        </ion-row>
      </ion-grid>
    </mat-card-content>
  </mat-card>

  <div class="space-between-components"></div>

  <mat-card *ngIf="return" [ngClass]="{'from-history': isHistoric}">
    <mat-card-header>
      <mat-card-title>
        {{isHistoric ? 'Información proporcionada por el operario' : 'A rellenar por el operario'}}
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <ion-grid>
        <ion-row>
          <ion-col size="4" [ngClass]="{'disabled-col': !isHistoric}">
            <ion-item>
              <ion-label position="stacked">Jaulas contenedoras</ion-label>
              <ion-input disabled>{{getPackingNames(return.packings)}}</ion-input>
            </ion-item>
          </ion-col>

          <ion-col size="4">
            <ion-item>
              <ion-label position="stacked">Nº Bultos{{ !isHistoric && requiredFields.quantityPacking ? ' *' : '' }}</ion-label>
              <ion-input [disabled]="isHistoric" [(ngModel)]="return.amountPackages" type="number"></ion-input>
            </ion-item>
          </ion-col>

          <ion-col size="4">
            <ion-item class="item-date" [disabled]="isHistoric">
              <ion-label position="stacked">Fecha prevista de
                recogida{{ !isHistoric && requiredFields.pickupDate ? ' *' : '' }}</ion-label>
              <input matInput [matDatepicker]="pickerDatePredictedPickup" [(ngModel)]="return.datePredictedPickup">
              <mat-datepicker-toggle matSuffix [for]="pickerDatePredictedPickup"></mat-datepicker-toggle>
              <mat-datepicker #pickerDatePredictedPickup></mat-datepicker>
            </ion-item>
          </ion-col>
        </ion-row>

        <ion-row>
          <ion-col size="4">
            <ion-item>
              <ion-label position="stacked">Agencia transportista{{ !isHistoric && requiredFields.shipper ? ' *' : '' }}</ion-label>
              <ion-input [disabled]="isHistoric" [(ngModel)]="return.shipper"></ion-input>
            </ion-item>
          </ion-col>

          <ion-col size="4" *ngIf="!isHistoric">
            <ion-item>
              <div class="div-btn-item">
                <ion-button matTooltip="Adjuntar albarán de agencia" matTooltipClass="tooltip" slot="start" fill="clear" [disabled]="!return || (!return.id && !requiredFields.deliveryNote)" (click)="searchDelivery_note()">
                  <ion-icon name="image" slot="start"></ion-icon>albarán agencia{{requiredFields.deliveryNote ? ' *' : ''}}
                </ion-button>
              </div>
            </ion-item>
          </ion-col>

          <ion-col size="4" [ngClass]="{'disabled-col': !isHistoric}">
            <ion-item class="item-date">
              <ion-label position="stacked">Fecha de recogida</ion-label>
              <ion-input
                disabled>{{return.datePickup ? formatDate(return.datePickup) : 'Esta fecha se rellenará más adelante'}}</ion-input>
            </ion-item>
          </ion-col>
        </ion-row>

        <ion-row>
          <ion-col>
            <ion-item [disabled]="isHistoric">
              <ion-label position="stacked">Observaciones del operario</ion-label>
              <ion-textarea rows="3" cols="20" [placeholder]="isHistoric ? 'No se ha añadido ninguna observación a la devolución' : 'Introduzca aquí sus observaciones'"
                            [(ngModel)]="return.operatorObservations" type="text"></ion-textarea>
            </ion-item>
          </ion-col>
        </ion-row>
      </ion-grid>
    </mat-card-content>
  </mat-card>

  <div *ngIf="return && isHistoric">
    <div class="space-between-components"></div>
    <horizontal-images-list *ngIf="return.archives && return.archives.length" [title]="'Archivos'" [archives]="return.archives"></horizontal-images-list>
    <div class="space-between-components" *ngIf="return.delivery_notes && return.delivery_notes.length"></div>
    <horizontal-images-list *ngIf="return.delivery_notes && return.delivery_notes.length" [title]="'Albarán Agencia'" [archives]="return.delivery_notes"></horizontal-images-list>
  </div>
</ion-content>

<ion-footer>
  <ion-toolbar *ngIf="isHistoric else toolbarEdition">
    <ion-button matTooltip="Imprimir/enviar albarán" matTooltipClass="tooltip" slot="start" fill="clear" (click)="deliveryNote()"><ion-icon name="print" slot="start"></ion-icon> albarán</ion-button>
    <ion-button slot="end" color="light" (click)="router.navigateByUrl('/returns-historic')">Volver al Listado</ion-button>
  </ion-toolbar>
  <ng-template #toolbarEdition>
    <ion-toolbar>
      <ion-button matTooltip="Imprimir/enviar albarán" matTooltipClass="tooltip" slot="start" fill="clear" [disabled]="!return || !return.id" (click)="deliveryNote()"><ion-icon name="print" slot="start"></ion-icon> albarán</ion-button>
      <ion-button matTooltip="Adjuntar archivos/imágenes" matTooltipClass="tooltip" slot="start" fill="clear" [disabled]="!return || !return.id" (click)="searchArchive()"><ion-icon name="attach" slot="start"></ion-icon>archivos/imágenes</ion-button>

      <ion-button slot="end" color="light" (click)="router.navigateByUrl('/return-tracking-list')">Cancelar</ion-button>
      <ion-button slot="end" color="primary" [disabled]="!allFieldsFilled()" (click)="save(null)">Guardar</ion-button>
    </ion-toolbar>
  </ng-template>
</ion-footer>
