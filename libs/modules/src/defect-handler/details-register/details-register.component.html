<ion-header>
    <ion-toolbar color="primary">
        <ion-buttons slot="start">
            <ion-button matTooltip="Cerrar" matTooltipClass="tooltip" (click)="closeWithoutSave()">
                <ion-icon name="close" class="toogleArrow"></ion-icon>
            </ion-button>
        </ion-buttons>
        <ion-buttons slot="start">
          <ion-button matTooltip="Imprimir" matTooltipClass="tooltip" (click)="print(registry)" *ngIf="registry?.statusManagementDefect?.ticketEmit">
            <ion-icon name="print" class="toogleArrow"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>{{ registry?.warehouse?.reference }}/{{registry?.warehouseDefectIdentifier}}</ion-title>
    </ion-toolbar>
</ion-header>
<ion-content>
    <ion-segment [(ngModel)]="section">
        <ion-segment-button value="information">
            <ion-label>Información</ion-label>
        </ion-segment-button>
        <ion-segment-button value="historical">
            <ion-label>Histórico</ion-label>
        </ion-segment-button>
    </ion-segment>
  <form [formGroup]="incidenceForm">
    <div *ngIf="section == 'information'">
        <ion-list class="ion-padding">
          <ion-item>
            <ion-label>
              Usuario: {{registry?.user?.name}}
            </ion-label>
          </ion-item>
          <ion-item>
            <ion-label>
              Almacén: {{registry?.warehouse ? (registry?.warehouse.reference + " - " + registry?.warehouse.name) : ""}}
            </ion-label>
          </ion-item>
          <ion-item>
            <ion-label>
              Modelo: {{registry?.product?.model?.reference}}
            </ion-label>
          </ion-item>
          <ion-item>
            <ion-label>
              Talla: {{registry?.product?.size?.name}}
            </ion-label>
          </ion-item>
          <ion-item>
            <ion-label>
              Marca: {{registry?.product?.model?.brand?.name}}
            </ion-label>
          </ion-item>
          <ion-item *ngIf="registry?.factoryReturn">
            <ion-label>
              Color: {{registry?.product?.model?.color?.name}}
            </ion-label>
          </ion-item>
          <ion-item>
            <ion-label>
              Producto: {{registry?.product?.reference}}
            </ion-label>
          </ion-item>
          <ion-item *ngIf="registry?.factoryReturn">
            <ion-label>
              Devolución a Fábrica: {{ registry?.factoryReturn ? 'Si' : 'No' }}
            </ion-label>
          </ion-item>
          <ion-item *ngIf="registry?.statusManagementDefect">
            <ion-label>
              Estado actual: {{registry.statusManagementDefect.name}}
            </ion-label>
          </ion-item>

          <ion-item (click)="clickSelectPopover($event, 'status')">
            <ion-label class="label-text">Estado nuevo:</ion-label>
            <ion-label class="content-select" style="text-align: center" *ngIf="!defectStatus"><font color="#808080">Selecciona</font> <i></i></ion-label>
            <ion-label class="content-select" style="text-align: center" *ngIf="defectStatus">{{ defectStatus.name }} <i></i></ion-label>
          </ion-item>
          <ion-item (click)="clickSelectPopover($event, 'typeP')" [disabled]="barcodeRoute!=null || selectGestionState == false">
            <ion-label class="ion-text-capitalize label-text">Defecto</ion-label>
            <ion-label class="content-select" style="text-align: center" *ngIf="!defectTypeP"><font color="#808080">Selecciona</font> <i></i></ion-label>
            <ion-label class="content-select" style="text-align: center" *ngIf="defectTypeP">{{ defectTypeP.name }} <i></i></ion-label>
          </ion-item>

          <ion-item (click)="clickSelectPopover($event, 'typeC')" [disabled]="registry.defectTypeParent==null  || selectGestionState == false">
            <ion-label class="ion-text-capitalize label-text">Subdefecto</ion-label>
            <ion-label class="content-select" style="text-align: center" *ngIf="!defectTypeC"><font color="#808080">Selecciona</font> <i></i></ion-label>
            <ion-label class="content-select" style="text-align: center" *ngIf="defectTypeC">{{ defectTypeC.name }} <i></i></ion-label>
          </ion-item>

          <ion-item (click)="clickSelectPopover($event, 'zoneP')" [disabled]="barcodeRoute!=null  || selectGestionState == false">
            <ion-label class="ion-text-capitalize label-text">Zona</ion-label>
            <ion-label class="content-select" style="text-align: center" *ngIf="!defectZoneP"><font color="#808080">Selecciona</font> <i></i></ion-label>
            <ion-label class="content-select" style="text-align: center" *ngIf="defectZoneP">{{ defectZoneP.name }} <i></i></ion-label>
          </ion-item>

          <ion-item (click)="clickSelectPopover($event, 'zoneC')" [disabled]="registry.defectZoneParent==null || selectGestionState == false">
            <ion-label class="ion-text-capitalize label-text">Subzona</ion-label>
            <ion-label class="content-select" style="text-align: center" *ngIf="!defectZoneC"><font color="#808080">Selecciona</font> <i></i></ion-label>
            <ion-label class="content-select" style="text-align: center" *ngIf="defectZoneC">{{ defectZoneC.name }} <i></i></ion-label>
          </ion-item>
          <ion-item *ngIf="selectGestionState == true">
            <ion-textarea placeholder="Observaciones..." formControlName="observations" type="text"></ion-textarea><br>
          </ion-item>
          <br><br>

          <div *ngIf="requireContact == true && selectGestionState == true" class="contact">
            <div formGroupName = "contact">
              <ion-item lines="none">
                <ion-label class="ion-text-capitalize label-text">Contacto</ion-label>
                <ion-input type="text" formControlName="name"  (keyup)="onKeyName($event)" placeholder="Nombre" maxlength="50"></ion-input>
              </ion-item>
              <ion-item lines="none">
                <ion-input type="text" formControlName="info" (keyup)="onKeyInfo($event)" placeholder="Tlf./Email"></ion-input><br>
              </ion-item>
            </div>
          </div>

          <div *ngIf="selectGestionState == true">

            <ion-item lines="none" *ngIf="requirePhoto == true" lines="none">
              <ion-label class="ion-text-capitalize label-text">capturar / buscar fotos</ion-label>
              <ion-button (click)="takePhoto()" class="icon-camare">
                <ion-icon name="camera"></ion-icon>
              </ion-button>
              <ion-button (click)="searchPhoto()">
                <ion-icon name="images"></ion-icon>
              </ion-button>
            </ion-item>

            <ion-item *ngIf="requirePhoto && photoList" (click)="showPhotoList()" lines="none">
              <ion-label class="label-text">Fotos añadidas</ion-label>
              <ion-icon slot="end" *ngIf="displayPhotoList" name="arrow-down"></ion-icon>
              <ion-icon slot="end" *ngIf="!displayPhotoList" name="arrow-up"></ion-icon>
            </ion-item>
            <ion-list *ngIf="photoList && requirePhoto && displayPhotoList">
              <ion-item  lines="none" *ngFor="let item of photos; let i = index">
                <ion-img (click)="onOpenReviewModal(item)"  slot="start" [src]="item.pathIcon"></ion-img>
                <ion-button slot="end"(click)="deleteImage(item, i, photos)">
                  <ion-icon slot="icon-only" name="trash"></ion-icon>
                </ion-button>
              </ion-item>
            </ion-list>

          </div>

          <div *ngIf="selectGestionState == true">
            <ion-item lines="none" *ngIf="requireOk == true">
              <ion-label lines="none" class="ion-text-capitalize label-text">generar firma</ion-label>
              <ion-button (click)="signModal()">
                <ion-icon name="finger-print"></ion-icon>
              </ion-button>
            </ion-item>
            <ion-item *ngIf="signatures && requireOk == true" (click)="openSignatureList()" lines="none">
              <ion-label class="label-text">Firma</ion-label>
              <ion-icon slot="end" *ngIf="signatureList" name="arrow-down"></ion-icon>
              <ion-icon slot="end" *ngIf="!signatureList" name="arrow-up"></ion-icon>
            </ion-item>
            <ion-list  *ngIf="signatures && signatureList && requireOk">
              <ion-item lines="none">
                <ion-img (click)="onOpenReviewModal(signatures)" slot="start" [src]="signatures.pathIcon"></ion-img>
                <ion-button slot="end" (click)="deleteSignature(signatures)">
                  <ion-icon slot="icon-only" name="trash"></ion-icon>
                </ion-button>
              </ion-item>
            </ion-list>
          </div>

          <mat-expansion-panel *ngIf="registry?.statusManagementDefect?.requirePhoto && registry?.photos?.length > 0">
            <mat-expansion-panel-header>
              <mat-panel-title>
                Fotos
              </mat-panel-title>
            </mat-expansion-panel-header>
            <ion-item *ngFor="let photo of registry.photos">
              <img src="{{baseUrlPhoto}}{{photo.pathMedium}}" alt="" />
            </ion-item>
          </mat-expansion-panel>
          <br/>
          <mat-expansion-panel *ngIf="registry?.statusManagementDefect?.requireOk && registry?.signature?.pathMedium">
            <mat-expansion-panel-header>
              <mat-panel-title>
                Firma
              </mat-panel-title>
            </mat-expansion-panel-header>
            <ion-item>
              <img src="{{baseUrlPhoto}}{{registry?.signature?.pathMedium}}" alt="" />
            </ion-item>
          </mat-expansion-panel>
        </ion-list>
    </div>

    <div *ngIf="section == 'historical'">
        <ion-list>
          <div *ngFor="let historical of registryHistorical; let i = index" class="ion-padding">
            <div>
              <p>
                Usuario: {{ historical?.user?.name }}
              </p>
              <p>
                Fecha de Detección: {{ historical?.updatedAt | date:"dd/MM/yyyy HH:mm:ss" }}
              </p>
            </div>
            <mat-expansion-panel>
              <mat-expansion-panel-header>
                <mat-panel-title>
                  Estado: {{historical.statusManagementDefect.name}}
                </mat-panel-title>
              </mat-expansion-panel-header>
              <ion-list>
                <ion-item>
                  <ion-label>
                    Producto: {{ historical?.product?.reference }}
                  </ion-label>
                </ion-item>
              </ion-list>
              <div *ngIf="getRequireStatus(historical.statusManagementDefect, 'contact')" class="contact">
                <ion-list>
                  <ion-list-header>
                    <h2>Contacto</h2>
                  </ion-list-header>
                  <ion-item>
                    <ion-label>
                      Nombre: {{ historical?.contact?.name }}
                    </ion-label>
                  </ion-item>
                  <ion-item>
                    <ion-label>
                      Tlf./Email: {{ historical?.contact?.info }}
                    </ion-label>
                  </ion-item>
                </ion-list>
              </div>
              <mat-expansion-panel class="photos" *ngIf="getRequireStatus(historical.statusManagementDefect, 'photo') && historical?.photos?.length > 0">
                <mat-expansion-panel-header>
                  <mat-panel-title>
                    Fotos
                  </mat-panel-title>
                </mat-expansion-panel-header>
                <ion-item lines="none" *ngFor="let photo of historical.photos">
                  <img [src]="baseUrlPhoto + photo.pathMedium" alt="" />
                  <ion-item-divider></ion-item-divider>
                </ion-item>
              </mat-expansion-panel>
              <mat-expansion-panel class="signature" *ngIf="getRequireStatus(historical.statusManagementDefect, 'signature') && historical.signature.pathMedium">
                <mat-expansion-panel-header>
                  <mat-panel-title>
                    Firma
                  </mat-panel-title>
                </mat-expansion-panel-header>
                <ion-item lines="none">
                  <ion-img [src]="baseUrlPhoto + historical.signature.pathMedium"></ion-img>
                </ion-item>
              </mat-expansion-panel>
            </mat-expansion-panel>
          </div>
        </ion-list>
        <ion-item-divider></ion-item-divider>
    </div>
  </form>
</ion-content>
<div class="toolbar-buttons">
  <ion-fab vertical="bottom" horizontal="end">
    <ion-fab-button matTooltip="Cambiar Estado" matTooltipClass="tooltip" [disabled]="!isFormComplete()"
                    (click)="send()">
      <ion-icon name="save"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</div>
