<ion-content scrollY="true">
  <form [formGroup]="incidenceForm">
    <ng-container *ngIf="!readed;else read">
      <scanner-manual (newValue)=newValue($event) placeholder="PRODUCTO"></scanner-manual>
      <ion-fab vertical="top" horizontal="end" class="scandit-fab">
        <ion-fab-button (click)="scanNewCode()">
          <i class="material-icons">crop_free</i>
        </ion-fab-button>
      </ion-fab>
    </ng-container>
    <ng-template #read>
      <ion-item>
        <ion-label class="label-text">Producto:</ion-label>
        <ion-input class="input-barcode" id="input-product-reference" formControlName="productReference" type="text" readonly
                   style="text-align: right;"></ion-input><br>
        <ion-input *ngIf="barcodeRoute!=null" class="input-barcode" formControlName="productReference" type="text"
                   readonly style="text-align: right;">{{barcode}}</ion-input><br>
      </ion-item>
      <ion-item>
        <ion-label class="label-text">Fecha</ion-label>
        <ion-datetime formControlName="dateDetection" picker-format="DD/MM/YYYY" display-format="DD/MM/YYYY" format>
        </ion-datetime>
        <!--<ion-input *ngIf="barcodeRoute!=null" class="input-barcode" type="text" readonly style="text-align: right;" [value]="this.dateNow"></ion-input><br>-->
      </ion-item>
      <ion-item (click)="clickSelectPopover($event, 'status')" [disabled]="barcodeRoute!=null">
        <ion-label class="label-text">Estado de gestion</ion-label>
        <ion-label class="content-select" style="text-align: center" *ngIf="!defectStatus"><font color="#808080">Selecciona</font> <i></i></ion-label>
        <ion-label class="content-select" style="text-align: center" *ngIf="defectStatus">{{ defectStatus.name }} <i></i></ion-label>
      </ion-item>

      <ion-item (click)="clickSelectPopover($event, 'typeP')" [disabled]="barcodeRoute!=null">
        <ion-label class="ion-text-capitalize label-text">Defecto</ion-label>
        <ion-label class="content-select" style="text-align: center" *ngIf="!defectTypeP"><font color="#808080">Selecciona</font> <i></i></ion-label>
        <ion-label class="content-select" style="text-align: center" *ngIf="defectTypeP">{{ defectTypeP.name }} <i></i></ion-label>
      </ion-item>

      <ion-item (click)="clickSelectPopover($event, 'typeC')" [disabled]="defectTypeP==null">
        <ion-label class="ion-text-capitalize label-text">Subdefecto</ion-label>
        <ion-label class="content-select" style="text-align: center" *ngIf="!defectTypeC"><font color="#808080">Selecciona</font> <i></i></ion-label>
        <ion-label class="content-select" style="text-align: center" *ngIf="defectTypeC">{{ defectTypeC.name }} <i></i></ion-label>
      </ion-item>

      <ion-item (click)="clickSelectPopover($event, 'zoneP')" [disabled]="barcodeRoute!=null">
        <ion-label class="ion-text-capitalize label-text">Zona</ion-label>
        <ion-label class="content-select" style="text-align: center" *ngIf="!defectZoneP"><font color="#808080">Selecciona</font> <i></i></ion-label>
        <ion-label class="content-select" style="text-align: center" *ngIf="defectZoneP">{{ defectZoneP.name }} <i></i></ion-label>
      </ion-item>

      <ion-item (click)="clickSelectPopover($event, 'zoneC')" [disabled]="defectZoneP==null">
        <ion-label class="ion-text-capitalize label-text">Subzona</ion-label>
        <ion-label class="content-select" style="text-align: center" *ngIf="!defectZoneC"><font color="#808080">Selecciona</font> <i></i></ion-label>
        <ion-label class="content-select" style="text-align: center" *ngIf="defectZoneC">{{ defectZoneC.name }} <i></i></ion-label>
      </ion-item>

      <ion-item>
        <ion-textarea formControlName="observations" placeholder="Observaciones..." [readonly]="barcodeRoute!=null"></ion-textarea>
      </ion-item>

      <div *ngIf="requireContact == true" class="contact">
        <div formGroupName="contact">
          <ion-item lines="none">
            <ion-label class="ion-text-capitalize label-text">Contacto</ion-label><br>
          </ion-item>
          <ion-item lines="none">
            <ion-input type="text" formControlName="name" (keyup)="onKeyName($event)" placeholder="Nombre"
                       maxlength="50"></ion-input><br>
          </ion-item>
          <ion-item lines="none">
            <ion-input type="text" formControlName="info" (keyup)="onKeyInfo($event)" placeholder="Tlf/Email"
                       maxlength="50"></ion-input><br>
          </ion-item>
        </div>
      </div>

      <ion-item lines="none" *ngIf="requirePhoto == true" lines="none">
        <ion-label class="ion-text-capitalize label-text">capturar / buscar fotos</ion-label>
        <ion-button (click)="takePhoto()" class="icon-camare">
          <ion-icon name="camera"></ion-icon>
        </ion-button>
        <ion-button (click)="searchPhoto()">
          <ion-icon name="images"></ion-icon>
        </ion-button>
      </ion-item>
      <ion-item *ngIf="photos.length > 0 &&  requirePhoto == true" (click)="openPhotoList()" lines="none">
        <ion-label class="label-text">Fotos</ion-label>
        <ion-icon slot="end" *ngIf="photoList" name="arrow-down"></ion-icon>
        <ion-icon slot="end" *ngIf="!photoList" name="arrow-up"></ion-icon>
      </ion-item>
      <ion-list *ngIf=" photos.length > 0 && photoList && requirePhoto">
        <ion-item lines="none" *ngFor="let item of photos; let i = index">
          <ion-img (click)="onOpenReviewModal(item)" slot="start" [src]="item.pathIcon"></ion-img>
          <ion-button slot="end" (click)="deleteImage(item, i, photos)">
            <ion-icon slot="icon-only" name="trash"></ion-icon>
          </ion-button>
        </ion-item>
      </ion-list>


      <ion-item lines="none" *ngIf="requireOk == true">
        <ion-label lines="none" class="ion-text-capitalize label-text">generar firma</ion-label>
        <ion-button (click)="signModal()">
          <ion-icon name="finger-print"></ion-icon>
        </ion-button>
      </ion-item>
      <ion-item *ngIf="signatures && requireOk == true" (click)="openSignatureList()" lines="none">
        <ion-label class="label-text">Firma</ion-label>
        <ion-icon slot="end" *ngIf="signatureList" name="arrow-down"></ion-icon>
        <ion-icon slot="end" *ngIf="!signatureList" name="arrow-up"></ion-icon>
      </ion-item>
      <ion-list *ngIf="signatures && signatureList && requireOk">
        <ion-item lines="none">
          <ion-img (click)="onOpenReviewModal(signatures)" slot="start" [src]="signatures.pathIcon"></ion-img>
          <ion-button slot="end" (click)="deleteSignature(signatures)">
            <ion-icon slot="icon-only" name="trash"></ion-icon>
          </ion-button>
        </ion-item>
      </ion-list>
    </ng-template>
  </form>
</ion-content>

<div class="toolbar-buttons">
  <ion-fab vertical="bottom" horizontal="end" *ngIf="readed && barcodeRoute==null">
    <ion-fab-button matTooltip="Confirmar Defectuoso" matTooltipClass="tooltip" (click)="send()"
                    [attr.disabled]="!isFormComplete()">
      <ion-icon name="save"></ion-icon>
    </ion-fab-button>
  </ion-fab>

  <ion-fab vertical="bottom" horizontal="end" *ngIf="readed && barcodeRoute!=null">
    <ion-fab-button matTooltip="Confirmar Defectuoso" matTooltipClass="tooltip"
                    (click)="enviaryarn()" [disabled]="!isFormComplete()">
      <ion-icon name="save"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</div>
